steps:
  - name: 'gcr.io/cloud-builders/gcloud'
    id: Connect to instance
    entrypoint: /bin/sh
    args:
    - '-c'
    - |
      mkdir -p /builder/home/.ssh
      gcloud secrets versions access latest --secret=cloud-build-ssh-key > /builder/home/.ssh/id_rsa
      chmod 600 /builder/home/.ssh/id_rsa
      gcloud secrets versions access latest --secret=cloud-build-ssh-key-pub > /builder/home/.ssh/id_rsa.pub
      chmod 600 /builder/home/.ssh/id_rsa.pub
      
      # Fetch instance metadata and ensure the public key is added
      gcloud compute instances add-metadata rd-df-pipelines \
        --zone=us-central1-c \
        --metadata-from-file ssh-keys=/builder/home/.ssh/id_rsa.pub
      
      set -x
      gcloud compute ssh rd-df-pipelines --ssh-key-file=/builder/home/.ssh/id_rsa --zone=us-central1-c
